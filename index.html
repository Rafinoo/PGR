<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PG Auto Tool - Copy/Export Ready</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function addMinutes(time, minsToAdd) {
    let [h, m] = time.split(':').map(Number);
    m += minsToAdd;
    h += Math.floor(m/60);
    m = m % 60;
    return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0');
}

function timeDiffInMinutes(start, stop) {
    const [sh, sm] = start.split(':').map(Number);
    const [eh, em] = stop.split(':').map(Number);
    return (eh*60 + em) - (sh*60 + sm);
}

function parseAndFill() {
    const text = document.getElementById("inputData").value;
    const lines = text.split("\n").map(x => x.trim()).filter(x => x);

    let siteGeneric = (lines.find(x => x.startsWith("Site:")) || "").split(":")[1]?.trim() || "";
    let date = lines.find(x => /^\d{1,2}-\d{1,2}-\d{4}$/.test(x)) || "";
    let executor = (lines.find(x => x.startsWith("Operator:")) || "").split(":")[1]?.trim() || "";

    const pgTimes = [];
    for(let i=0;i<lines.length;i++){
        if(lines[i].startsWith("PG start time:")){
            let start = lines[i].split('PG start time:')[1].trim();
            let stopLine = lines[i+1] && lines[i+1].startsWith("PG stop time:") ? lines[i+1] : null;
            if(stopLine){
                let stop = stopLine.split('PG stop time:')[1].trim();
                pgTimes.push({start, stop});
            }
        }
    }

    const tbody = document.getElementById("pgTableBody");
    tbody.innerHTML = "";
    let count = 1;

    if(pgTimes.length>0){
        const first = pgTimes[0];
        const firstDurationMinutes = Math.min(60, timeDiffInMinutes(first.start, first.stop));
        const firstDurationHHMM = Math.floor(firstDurationMinutes/60)+':'+(firstDurationMinutes%60).toString().padStart(2,'0');
        const firstTotalRH = (firstDurationMinutes/60).toFixed(1);
        tbody.appendChild(generateRow(count++, siteGeneric, date, executor, date, first.start, addMinutes(first.start, firstDurationMinutes), firstDurationHHMM, firstTotalRH, 'BL Provide PG','PGONM0004'));

        const nextStart = addMinutes(first.start, firstDurationMinutes + 5);
        const nextStop = addMinutes(first.stop,5);
        const nextDurationMinutes = timeDiffInMinutes(nextStart,nextStop);
        if(nextDurationMinutes>0){
            const nextDurationHHMM = Math.floor(nextDurationMinutes/60)+':'+(nextDurationMinutes%60).toString().padStart(2,'0');
            const nextTotalRH = (nextDurationMinutes/60).toFixed(1);
            tbody.appendChild(generateRow(count++, siteGeneric, date, executor, date, nextStart, nextStop, nextDurationHHMM, nextTotalRH, 'BL Provide PG','PGONM0005'));
        }

        for(let i=1;i<pgTimes.length;i++){
            const pg = pgTimes[i];
            const durationMinutes = timeDiffInMinutes(pg.start, pg.stop);
            const durationHHMM = Math.floor(durationMinutes/60)+':'+(durationMinutes%60).toString().padStart(2,'0');
            const totalRH = (durationMinutes/60).toFixed(1);
            tbody.appendChild(generateRow(count++, siteGeneric, date, executor, date, pg.start, pg.stop, durationHHMM, totalRH, 'BL Provide PG','PGONM0005'));
        }
    }
}

function generateRow(sn, siteGeneric, notifDate, executor, execDate, start, stop, duration, totalRH, workDesc, itemCode){
    // BL Override checkbox check
    const blOverride = document.getElementById('blOverride').checked;
    if(blOverride){
        if(itemCode === 'PGONM0004') itemCode = 'PGONM0001';
        else if(itemCode === 'PGONM0005') itemCode = 'PGONM0002';
    }

    const itemData = {
        'PGONM0001': {
            desc: '0- 1 hours PG Running charge for vendor provided PG (Octane/Petrol Operated)',
            uom: 'Per TT/Day',
            supply: 'Service',
            unitPrice: '3,118.59',
            claimQty: '1.0',
            claimCost: '3,118.6',
            verifiedQty: '-',
            totalCost: '-',
            dhalyResp: ''
        },
        'PGONM0002': {
            desc: 'For any additional RH after 3 hours upto 1 day for vendor provided PG (Octane/Petrol Operated).',
            uom: 'Per additional RH',
            supply: 'Service',
            unitPrice: '538.20',
            claimQty: totalRH,
            claimCost: (parseFloat(totalRH)*538.20).toFixed(1),
            verifiedQty: '-',
            totalCost: '-',
            dhalyResp: ''
        },
        'PGONM0004': {
            desc: '0- 1 hours PG Running charge for vendor provided PG (Octane/Petrol Operated)',
            uom: 'Per TT/Day',
            supply: 'Service',
            unitPrice: '3,565.00',
            claimQty: '1.0',
            claimCost: '3,565.0',
            verifiedQty: '-',
            totalCost: '-',
            dhalyResp: ''
        },
        'PGONM0005': {
            desc: 'For any additional RH after 3 hours upto 1 day for vendor provided PG (Octane/Petrol Operated).',
            uom: 'Per additional RH',
            supply: 'Service',
            unitPrice: '538.20',
            claimQty: totalRH,
            claimCost: (parseFloat(totalRH)*538.20).toFixed(1),
            verifiedQty: '-',
            totalCost: '-',
            dhalyResp: ''
        }
    };

    const data = itemData[itemCode] || {};

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${sn}</td><td></td><td></td><td></td>
<td></td>
<td>${siteGeneric}</td>
<td>${notifDate}</td><td></td><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>${executor}</td>
<td>${execDate}</td>
<td>${start}</td>
<td>${stop}</td>
<td>${duration}</td>
<td>${totalRH}</td>
<td>${workDesc}</td>
<td>${itemCode}</td>
<td>${data.desc || ''}</td>
<td>${data.uom || ''}</td>
<td>${data.supply || ''}</td>
<td>${data.unitPrice || ''}</td>
<td>${data.claimQty || ''}</td>
<td>${data.claimCost || ''}</td>
<td>${data.verifiedQty || ''}</td>
<td>${data.totalCost || ''}</td>
<td>${data.dhalyResp || ''}</td>
<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
    return tr;
}

function exportTableToExcel(tableID, filename = ''){
    var dataType = 'application/vnd.ms-excel';
    var tableSelect = document.getElementById(tableID);
    var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    filename = filename?filename+'.xls':'PG_Data.xls';
    var downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    if(navigator.msSaveOrOpenBlob){
        var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
        navigator.msSaveOrOpenBlob( blob, filename);
    } else {
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
        downloadLink.download = filename;
        downloadLink.click();
    }
}

function copyOutput() {
    const table = document.getElementById('pgTable');
    let output = '';
    for (let r = 0; r < table.rows.length; r++) {
        const row = table.rows[r];
        let rowData = [];
        for (let c = 0; c < row.cells.length; c++) {
            rowData.push(row.cells[c].innerText);
        }
        output += rowData.join('\t') + '\n';
    }
    navigator.clipboard.writeText(output).then(() => {
        alert('Output copied to clipboard! Excel-এ paste করতে পারো।');
    });
}
</script>
</head>
<body class="p-4">
<h2 class="mb-3">PG Auto Tool - Copy & Export Ready</h2>
<p>ডেটা পেস্ট করুন:</p>
<textarea id="inputData" class="form-control mb-2" placeholder="Paste your PG data here..."></textarea>

<!-- BL Override Checkbox -->
<div class="mb-3 form-check">
  <input type="checkbox" class="form-check-input" id="blOverride">
  <label class="form-check-label" for="blOverride">BL Override (Use PGONM0001/0002)</label>
</div>

<div class="mb-3">
  <button class="btn btn-success me-2" onclick="parseAndFill()">ডেটা আপডেট করুন</button>
  <button class="btn btn-primary me-2" onclick="copyOutput()">Copy Output</button>
  <button class="btn btn-warning" onclick="exportTableToExcel('pgTable')">Excel এ রপ্তানি করুন</button>
</div>

<h3>মোট রান টাইম: <span id="totalRun"></span></h3>

<div class="table-responsive">
<table id="pgTable" class="table table-bordered table-striped">
  <thead class="table-light">
    <tr>
      <th>S/N</th><th>Dhaly Office</th><th>Category(PGR/GPM..)</th><th>TR No</th>
      <th>Site ID</th><th>Site ID (Generic)</th><th>Notification Date</th><th>Notification Time</th>
      <th>Severity (H/M/L)</th><th>Attend Date</th><th>Attend Time</th><th>MTTR</th>
      <th>SLA Status</th><th>Executor (Name-Contact)</th><th>Execution/ PG Utilization Date</th>
      <th>Execution/ PG Start Time</th><th>PG Stop /End Time</th><th>Duration (HH:MM)</th>
      <th>Total PG RH (Hour)</th><th>Work Description</th><th>Item Code</th>
      <th>Item Description</th><th>UoM</th><th>Supply / Service</th><th>Unit Price</th>
      <th>Claim (Dhaly) Quantity</th><th>Claim (Dhaly) Cost</th><th>Verified (BL) Quantity</th><th>Total Cost</th>
      <th>Dhaly Responsible</th><th>BL On Call</th><th>BL On Call Feedback</th><th>BL 1st Feedback</th>
      <th>BL Remarks</th><th>LD Details (If any)</th><th>LD Count</th><th>LD Amount</th>
      <th>Dhaly 1st Feedback</th><th>BL 2nd Feedback</th><th>Vendor 2nd Feedback</th><th>BL Final Feedback</th>
      <th>BLBP Approval Date</th><th>TT Issued</th>
    </tr>
  </thead>
  <tbody id="pgTableBody"></tbody>
</table>
</div>

<div class="mt-3 text-muted">Website created by Rafinoor | 01629020071 | <a href="https://www.facebook.com/RN.rafinoor/about/" target="_blank">Facebook Profile</a></div>
</body>
</html>
